name: Automatisation des tests DevSecOps

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  dependances:
    name: Scan de securite des dependances
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Scan de securite avec Trivy (non bloquant)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs          # scan du filesystem du repo
          scan-ref: .            # Ã  partir de la racine
          vuln-type: os,library  # OS + libs (dont pip/requirements.txt)
          severity: LOW,MEDIUM,HIGH,CRITICAL
          format: table          # joli tableau dans les logs
          exit-code: 0           # ðŸ”´ IMPORTANT : ne fait JAMAIS echouer le job

  dockerfile:
    name: Build de l'image Docker
    runs-on: ubuntu-latest
    needs: dependances          # se lance aprÃ¨s le scan

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Build de l'image Docker (test du Dockerfile)
        run: |
          docker build -t breakableflask .

  deploy:
    name: Deploy (simulation)
    runs-on: ubuntu-latest
    needs: dockerfile

    steps:
      - name: Fake deploy
        run: |
          echo "Rien Ã  faire ici. L'application est prÃªte Ã  Ãªtre dÃ©ployÃ©e."
